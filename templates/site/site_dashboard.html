{% extends "site/site_base.html" %}

{% block title %}Hub | Business Better{% endblock %}

{% block head %}
<style>
    /* 1. TILE STYLE (Taken directly from your job_details.html) */
    .action-btn { 
        background-color: white;
        border-radius: 12px; 
        padding: 20px 10px; 
        font-weight: bold; 
        font-size: 0.9rem; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        width: 100%; 
        display: block;
        text-align: center;
        text-decoration: none;
        color: #333;
        transition: transform 0.1s;
        border: none;
        height: 100%;
        text-transform: uppercase;
    }
    .action-btn:active { transform: scale(0.98); }
    .action-btn i { font-size: 2rem; margin-bottom: 10px; display: block; }

    /* 2. CARD STYLE (Taken from your van_check_form.html) */
    .dashboard-card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 15px;
        background: white;
        text-decoration: none;
        display: block;
        color: inherit;
        overflow: hidden;
    }

    /* 3. STATUS BORDERS */
    .status-active { border-left: 8px solid #ffc107; }
    .status-scheduled { border-left: 8px solid var(--brand-color, #333); }

    /* 4. WELCOME AREA */
    .welcome-box {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }
    
    .date-header {
        font-weight: bold;
        color: #6c757d;
        text-transform: uppercase;
        font-size: 0.85rem;
        margin: 20px 0 10px 0;
        letter-spacing: 0.5px;
    }
</style>
{% endblock %}

{% block content %}

    <div class="welcome-box d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold m-0 text-dark">Hi, {{ staff_name.split(' ')[0] }}</h2>
            <div class="text-muted fw-bold small mt-1">{{ now_ymd }}</div>
        </div>
        
        <div class="text-end">
            {% if active_job %}
                <span class="badge bg-warning text-dark p-2 shadow-sm">
                    <i class="fas fa-hammer me-1"></i> WORKING
                </span>
            {% elif is_at_work %}
                <span class="badge bg-success p-2 shadow-sm">
                    <i class="fas fa-clock me-1"></i> CLOCKED IN
                </span>
            {% else %}
                <span class="badge bg-secondary p-2 shadow-sm">
                    OFF CLOCK
                </span>
            {% endif %}
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-4">
            <a href="/site/van-check" class="action-btn text-primary">
                <i class="fas fa-shuttle-van"></i>
                Check Van
            </a>
        </div>
        <div class="col-4">
            <a href="/site/log-fuel" class="action-btn text-warning">
                <i class="fas fa-gas-pump"></i>
                Log Fuel
            </a>
        </div>
        <div class="col-4">
            <a href="#" onclick="event.preventDefault(); document.getElementById('clockForm').submit();" 
               class="action-btn" 
               style="{{ 'color:#dc3545;' if is_at_work else 'color:#198754;' }}">
                
                {% if is_at_work %}
                    <i class="fas fa-stop-circle"></i>
                    End Day
                {% else %}
                    <i class="fas fa-play-circle"></i>
                    Start Day
                {% endif %}
            </a>
        </div>
    </div>

    <form id="clockForm" action="/site/toggle-day-clock" method="POST" style="display:none;">
        <input type="hidden" name="action" value="{{ 'stop' if is_at_work else 'start' }}">
    </form>

    <h5 class="fw-bold text-dark mb-3">Your Schedule</h5>

    {% if jobs %}
        {% set ns = namespace(last_date=None) %}
        
        {% for job in jobs %}
            
            {# DATE LOGIC #}
            {% if job.raw_date %}
                {% set display_date = job.display_date %}
                {% set compare_date = job.raw_date %}
            {% else %}
                {% set display_date = 'Unscheduled' %}
                {% set compare_date = 'None' %}
            {% endif %}
            
            {# DATE HEADER #}
            {% if ns.last_date != compare_date %}
                <div class="date-header">
                    {% if compare_date == now_ymd %}TODAY
                    {% else %}{{ display_date }}
                    {% endif %}
                </div>
                {% set ns.last_date = compare_date %}
            {% endif %}

            <a href="/site/job/{{ job.id }}" class="card dashboard-card {{ 'status-active' if job.status == 'In Progress' else 'status-scheduled' }}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge {{ 'bg-warning text-dark' if job.status == 'In Progress' else 'bg-light text-dark border' }}">
                            {{ job.status }}
                        </span>
                        <span class="fw-bold text-muted small">{{ job.ref }}</span>
                    </div>

                    <h5 class="fw-bold text-dark mb-1">{{ job.client or 'Unknown Client' }}</h5>
                    <div class="text-muted small mb-3">{{ job.desc|truncate(50) }}</div>

                    <div class="d-flex align-items-center text-secondary small fw-bold">
                        <i class="fas fa-map-marker-alt text-danger me-2"></i> {{ job.address }}
                    </div>
                </div>
            </a>

        {% endfor %}
    
    {% else %}
        <div class="text-center py-5 text-muted">
            <i class="fas fa-calendar-check fa-3x mb-3 opacity-25"></i>
            <h6 class="fw-bold text-muted text-uppercase small">No Jobs Scheduled</h6>
        </div>
    {% endif %}

    <div style="height: 60px;"></div>

{% endblock %}