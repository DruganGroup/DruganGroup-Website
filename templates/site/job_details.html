<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job #{{ job[1] }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 40px; }
        .header-bar { background-color: #333; color: white; padding: 15px; border-radius: 0 0 15px 15px; margin-bottom: 20px; }
        .action-btn { border-radius: 12px; padding: 15px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; margin-bottom: 10px; }
        .evidence-img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd; }
    </style>
</head>
<body>

    <div class="header-bar d-flex justify-content-between align-items-center">
        <a href="/site-hub" class="text-white"><i class="fas fa-arrow-left fa-lg"></i></a>
        <h4 class="m-0 fw-bold">{{ job[1] }}</h4> 
        <span class="badge {{ 'bg-success' if job[2] == 'In Progress' else 'bg-warning text-dark' }}">{{ job[2] }}</span> 
    </div>

    <div class="container">
        
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="alert alert-success shadow-sm rounded-4 mb-3">{{ messages[0] }}</div>
            {% endif %}
        {% endwith %}

        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body">
                <h6 class="text-muted fw-bold text-uppercase small">Location</h6>
                <h5 class="fw-bold mb-1">{{ job[7] }}</h5> 
                <div class="d-grid gap-2 mt-3">
                    <a href="https://maps.google.com/?q={{ job[7] }}" target="_blank" class="btn btn-primary fw-bold">
                        <i class="fas fa-map-marked-alt me-2"></i> Open in Maps
                    </a>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body">
                <h6 class="text-muted fw-bold text-uppercase small">Client Contact</h6>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold fs-5">{{ job[5] }}</div>
                        <div class="text-muted">{{ job[6] }}</div>
                    </div>
                    <a href="tel:{{ job[6] }}" class="btn btn-success rounded-circle p-3">
                        <i class="fas fa-phone fa-lg"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body">
                <h6 class="text-muted fw-bold text-uppercase small mb-3">Work Order</h6>
                <div class="alert alert-secondary border-0">
                    <i class="fas fa-info-circle me-2"></i> <strong>Desc:</strong> {{ job[8] }}
                </div>
            </div>
        </div>

        <div class="mb-4">
            {% if job[2] != 'In Progress' and job[2] != 'Completed' %}
                <form method="POST" action="/site/job/{{ job[0] }}/update">
                    <input type="hidden" name="action" value="start">
                    <button type="submit" class="btn btn-success action-btn text-white">
                        <i class="fas fa-play me-2"></i> Start Job
                    </button>
                </form>
            {% endif %}

            {% if job[2] == 'In Progress' %}
                <button class="btn btn-outline-dark action-btn" onclick="document.getElementById('photoInput').click();">
                    <i class="fas fa-camera me-2"></i> Add Evidence Photo
                </button>
                <form method="POST" action="/site/job/{{ job[0] }}/update" enctype="multipart/form-data" id="photoForm" style="display:none;">
                    <input type="hidden" name="action" value="upload_photo">
                    <input type="file" name="photo" id="photoInput" accept="image/*" capture="environment" onchange="document.getElementById('photoForm').submit();">
                </form>

                {% if not photos %}
                    <button type="button" class="btn btn-secondary action-btn" disabled>
                        <i class="fas fa-exclamation-triangle me-2"></i> Add Photo to Complete
                    </button>
                {% else %}
                    <button type="button" class="btn btn-primary action-btn text-white mt-2" data-bs-toggle="modal" data-bs-target="#completeJobModal">
                        <i class="fas fa-check-circle me-2"></i> Sign Off & Complete
                    </button>
                {% endif %}
            {% endif %}
        </div>

        {% if photos %}
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <h6 class="text-muted fw-bold text-uppercase small mb-3">Evidence Gallery</h6>
                <div class="d-flex flex-wrap gap-2">
                    {% for p in photos %}
                        <a href="/static/{{ p }}" target="_blank">
                            <img src="/static/{{ p }}" class="evidence-img">
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

    </div>

    <div class="modal fade" id="completeJobModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold">Job Completion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form method="POST" action="/site/job/{{ job[0] }}/update">
                        <input type="hidden" name="action" value="complete">
                        
                        <div class="mb-3">
                            <label class="fw-bold small text-muted">Materials / Work Done (For Invoice)</label>
                            <textarea name="work_summary" class="form-control" rows="3" placeholder="e.g. Replaced leaking pipe, used 2m copper..." required></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="fw-bold small text-danger">Private Office Notes (Internal Only)</label>
                            <textarea name="private_notes" class="form-control bg-light" rows="2" placeholder="e.g. Client was difficult, access code changed to 1234..."></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="fw-bold small text-muted">Client Signature (Type Name)</label>
                            <input type="text" name="signature" class="form-control form-control-lg" placeholder="e.g. John Smith" required>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg fw-bold">
                                <i class="fas fa-check-circle me-2"></i> Submit & Finish
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>