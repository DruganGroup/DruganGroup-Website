<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job #{{ job.ref }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 80px; }
        .header-bar { 
            background-color: {{ brand_color or '#333' }}; 
            color: white; 
            padding: 15px; 
            border-radius: 0 0 15px 15px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .action-btn { border-radius: 12px; padding: 15px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; margin-bottom: 10px; }
        .evidence-img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd; }
        .material-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .material-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div class="header-bar">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <a href="/site-hub" class="text-white"><i class="fas fa-arrow-left fa-lg"></i></a>
            
            {% if logo_url %}
                <img src="{{ logo_url }}" style="max-height: 40px; background: rgba(255,255,255,0.9); padding: 5px; border-radius: 5px;">
            {% else %}
                <span class="fw-bold text-uppercase small opacity-50">Site App</span>
            {% endif %}
            
            <span class="badge {{ 'bg-success' if job.status == 'In Progress' else 'bg-warning text-dark' }} shadow-sm">
                {{ job.status }}
            </span> 
        </div>
        <h4 class="m-0 fw-bold text-center">{{ job.ref }}</h4>
    </div>

    <div class="container">
        
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="alert alert-success shadow-sm rounded-4 mb-3 fw-bold">{{ messages[0] }}</div>
            {% endif %}
        {% endwith %}

        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body">
                <h6 class="text-muted fw-bold text-uppercase small">Location</h6>
                <h5 class="fw-bold mb-1">{{ job.address }}</h5> 
                
                {% if job.gate_code %}
                <div class="mt-2">
                    <span class="badge bg-dark text-warning"><i class="fas fa-key me-1"></i> Gate: {{ job.gate_code }}</span>
                </div>
                {% endif %}

                <div class="d-grid gap-2 mt-3">
                    <a href="https://maps.google.com/?q={{ job.address }}" target="_blank" class="btn btn-primary fw-bold">
    <i class="fas fa-map-marked-alt me-2"></i> Open in Maps
</a>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body">
                <h6 class="text-muted fw-bold text-uppercase small">Client Contact</h6>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold fs-5">{{ job.client_name }}</div>
                        <div class="text-muted">{{ job.client_phone }}</div>
                    </div>
                    {% if job.client_phone %}
                    <a href="tel:{{ job.client_phone }}" class="btn btn-success rounded-circle p-3">
                        <i class="fas fa-phone fa-lg"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body">
                <h6 class="text-muted fw-bold text-uppercase small mb-3">Work Order</h6>
                <div class="alert alert-secondary border-0">
                    <i class="fas fa-info-circle me-2"></i> <strong>Desc:</strong> {{ job.description }}
                </div>
            </div>
        </div>
        {% if 'Gas' in job.description or 'CP12' in job.description or 'Boiler' in job.description %}
        <div class="mb-3">
            <a href="/site/cert/cp12/create?job_id={{ job.id }}&prop_id={{ job.property_id }}" class="btn btn-warning w-100 fw-bold shadow-sm border border-warning text-dark py-3">
                <i class="fas fa-burn fa-lg me-2"></i> CREATE CP12 CERTIFICATE
            </a>
        </div>
        {% endif %}

        {% if 'EICR' in job.description or 'Electrical' in job.description or 'Wiring' in job.description %}
        <div class="mb-3">
            <a href="/site/cert/eicr/create?job_id={{ job.id }}&prop_id={{ job.property_id }}" class="btn btn-info w-100 fw-bold shadow-sm border border-info text-white py-3">
                <i class="fas fa-bolt fa-lg me-2"></i> CREATE EICR REPORT
            </a>
        </div>
        {% endif %}

        <div class="card shadow-sm border-0 mb-3">
            <div class="card-header bg-white border-bottom-0 d-flex justify-content-between align-items-center">
                <h6 class="text-muted fw-bold text-uppercase small m-0">Materials & Parts</h6>
                <button class="btn btn-sm btn-outline-primary fw-bold" data-bs-toggle="modal" data-bs-target="#addMaterialModal">
                    <i class="fas fa-plus me-1"></i> Add Item
                </button>
            </div>
            <div class="card-body pt-0">
                {% if materials %}
                    {% for mat in materials %}
                    <div class="material-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-light text-dark border me-2">{{ mat[1] }}x</span>
                            <strong>{{ mat[0] }}</strong>
                        </div>
                        <div class="text-muted small">£{{ mat[2] }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted small py-2">No items added yet.</div>
                {% endif %}
            </div>
        </div>

        <div class="mb-4">
            {% if job.status == 'Completed' %}
                <div class="alert alert-secondary text-center fw-bold">
                    <i class="fas fa-check-circle me-2"></i> Job Completed
                </div>

            {% elif user_is_clocked_in %}
                <div class="card bg-success text-white mb-3">
                    <div class="card-body text-center">
                        <div class="spinner-grow spinner-grow-sm text-white mb-2" role="status"></div>
                        <h6 class="fw-bold mb-2">YOU ARE CLOCKED IN</h6>
                        <p class="small text-white-50 mb-3">Time is being recorded.</p>
                        
                        <form method="POST" action="/site/job/{{ job.id }}/toggle-site-time">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="stop">
                            <button type="submit" class="btn btn-danger w-100 btn-lg fw-bold shadow border-2 border-white">
                                <i class="fas fa-sign-out-alt me-2"></i> STOP YOUR SHIFT
                            </button>
                        </form>
                    </div>
                </div>

            {% else %}
                <div class="card bg-light border-success mb-3">
                    <div class="card-body text-center">
                        <h6 class="fw-bold text-success mb-2">ARRIVED AT SITE?</h6>
                        <p class="small text-muted mb-3">Tap below to start YOUR shift.</p>
                        
                        <form method="POST" action="/site/job/{{ job.id }}/toggle-site-time">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="start">
                            <button type="submit" class="btn btn-success w-100 btn-lg fw-bold shadow">
                                <i class="fas fa-stopwatch me-2"></i> START YOUR SHIFT
                            </button>
                        </form>
                    </div>
                </div>
            {% endif %}
        </div>

        <button class="btn btn-outline-dark action-btn" onclick="document.getElementById('photoInput').click();">
            <i class="fas fa-camera me-2"></i> Add Evidence Photo
        </button>
        <form method="POST" action="/site/job/{{ job.id }}/update" enctype="multipart/form-data" id="photoForm" style="display:none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="upload_photo">
            <input type="file" name="photo" id="photoInput" accept="image/*" capture="environment" onchange="document.getElementById('photoForm').submit();">
        </form>

        {% if not photos %}
            <button type="button" class="btn btn-secondary action-btn" disabled>
                <i class="fas fa-exclamation-triangle me-2"></i> Add Photo to Complete
            </button>
        {% else %}
            <button type="button" class="btn btn-primary action-btn text-white mt-2" data-bs-toggle="modal" data-bs-target="#completeJobModal">
                <i class="fas fa-check-circle me-2"></i> Sign Off & Complete
            </button>
        {% endif %}

        {% if photos %}
        <div class="card shadow-sm border-0 mb-4 mt-3">
            <div class="card-body">
                <h6 class="text-muted fw-bold text-uppercase small mb-3">Evidence Gallery</h6>
                <div class="d-flex flex-wrap gap-2">
                    {% for p in photos %}
                        <a href="/static/{{ p }}" target="_blank">
                            <img src="/static/{{ p }}" class="evidence-img">
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

    </div>

    <div class="modal fade" id="addMaterialModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Add Material</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 pt-0">
                    <form method="POST" action="/site/job/{{ job.id }}/add-material">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="mb-3">
                            <label class="small fw-bold text-muted">Item Name / Description</label>
                            <input type="text" name="description" class="form-control form-control-lg" placeholder="e.g. 15mm Copper Elbow" required>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <label class="small fw-bold text-muted">Quantity</label>
                                <input type="number" name="quantity" class="form-control form-control-lg" value="1" required>
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold text-muted">Unit Price (£)</label>
                                <input type="number" step="0.01" name="price" class="form-control form-control-lg" placeholder="0.00">
                            </div>
                        </div>
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg fw-bold">Add to Job</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="completeJobModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold">Job Completion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form method="POST" action="/site/job/{{ job.id }}/update">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="action" value="complete">
                        
                        <div class="mb-3">
                            <label class="fw-bold small text-muted">Work Summary (For Invoice)</label>
                            <textarea name="work_summary" class="form-control" rows="3" placeholder="e.g. Replaced leaking pipe..." required></textarea>
                            <div class="form-text small text-primary"><i class="fas fa-magic me-1"></i> Materials listed above will be auto-added to the invoice.</div>
                        </div>

                        {% if session.get('employment_type') == 'Sub-Contractor' %}
                        <div class="alert alert-warning border-warning shadow-sm mb-3">
                            <h6 class="fw-bold text-dark"><i class="fas fa-file-invoice-dollar me-2"></i>Submit Invoice</h6>
                            <p class="small mb-2 text-muted">Enter your total labor & materials charge for this job.</p>
                            
                            <div class="input-group">
                                <span class="input-group-text fw-bold">£</span>
                                <input type="number" step="0.01" name="sub_contractor_cost" class="form-control fw-bold fs-5" placeholder="0.00">
                            </div>
                        </div>
                        {% endif %}
                        <div class="mb-3">
                            <label class="fw-bold small text-danger">Private Office Notes</label>
                            <textarea name="private_notes" class="form-control bg-light" rows="2" placeholder="Internal notes..."></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="fw-bold small text-muted">Client Signature</label>
                            <input type="text" name="signature" class="form-control form-control-lg" placeholder="e.g. John Smith" required>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg fw-bold">
                                <i class="fas fa-check-circle me-2"></i> Submit & Finish
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>