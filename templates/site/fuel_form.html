{% extends "site/site_base.html" %}

{% block title %}Log Fuel | Site Hub{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-warning text-dark fw-bold d-flex justify-content-between align-items-center">
            <span><i class="fas fa-gas-pump me-2"></i> Log Fuel for {{ reg }}</span>
            <span id="ai-badge" class="badge bg-dark text-warning" style="display:none;">
                <i class="fas fa-robot me-1"></i> AI Active
            </span>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" id="fuelForm">
                
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="mb-4 text-center p-4 border rounded bg-light" id="upload-area">
                    <label class="form-label fw-bold mb-3">ðŸ“¸ Step 1: Snap Receipt</label>
                    <input type="file" name="receipt" id="receiptInput" class="form-control" accept="image/*" capture="environment" required>
                    <div id="scan-status" class="mt-2 small text-muted">Upload to auto-fill details</div>
                    
                    <div id="loading-spinner" class="mt-3" style="display:none;">
                        <div class="spinner-border text-warning" role="status"></div>
                        <p class="small fw-bold mt-1 text-dark">AI Reading Receipt...</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Total Cost (Â£)</label>
                            <input type="number" step="0.01" name="total_cost" id="total_cost" class="form-control fw-bold" placeholder="0.00" required>
                        </div>
                    </div>
                    <div class="col-6">
                         <div class="mb-3">
                            <label class="form-label fw-bold small">Litres</label>
                            <input type="number" step="0.01" name="litres" id="litres" class="form-control fw-bold" placeholder="0.00" required>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small">Fuel Type</label>
                    <select name="fuel_type" id="fuel_type" class="form-select fw-bold">
                        <option value="Diesel" selected>Diesel</option>
                        <option value="Petrol">Petrol / Unleaded</option>
                        <option value="Premium Diesel">Premium Diesel</option>
                        <option value="Premium Petrol">Premium Petrol</option>
                        <option value="AdBlue">AdBlue</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small">Current Mileage (Odometer)</label>
                    <input type="number" name="mileage" class="form-control fw-bold" placeholder="e.g. 54000" required>
                </div>

                <button type="submit" class="btn btn-warning w-100 fw-bold py-3 shadow-sm">
                    <i class="fas fa-check-circle me-2"></i> Save Log
                </button>
                <a href="/site-hub" class="btn btn-outline-secondary w-100 mt-2">Cancel</a>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('receiptInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const status = document.getElementById('scan-status');
    const spinner = document.getElementById('loading-spinner');
    const badge = document.getElementById('ai-badge');
    
    status.style.display = 'none';
    spinner.style.display = 'block';

    const formData = new FormData();
    formData.append('receipt', file);
    
    // NOTE: This call needs to include the CSRF token in headers if using AJAX, 
    // but for now the user will just manually verify the data after the "scan" simulation.
    fetch('/site/api/scan-receipt', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': "{{ csrf_token() }}" // Added security for the API call too
        }
    })
    .then(response => response.json())
    .then(result => {
        spinner.style.display = 'none';
        
        if (result.success && result.data) {
            const data = result.data;
            if (data.total_cost) document.getElementById('total_cost').value = data.total_cost;
            if (data.litres) document.getElementById('litres').value = data.litres;
            if (data.fuel_type) document.getElementById('fuel_type').value = data.fuel_type;
            
            badge.style.display = 'inline-block';
            status.innerText = "âœ… Data extracted! Verify below.";
            status.style.display = 'block';
            status.className = "mt-2 small text-success fw-bold";
        } else {
            status.innerText = "Could not auto-read. Please type details.";
            status.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        spinner.style.display = 'none';
        status.innerText = "Manual entry required.";
        status.style.display = 'block';
    });
});
</script>
{% endblock %}