{% extends "finance/finance_base.html" %}

{% block title %}Payroll | Business Better{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold m-0">Payroll Run</h2>
        <p class="text-muted mb-0">
            Week Commencing: <span class="text-dark fw-bold">{{ week_start.strftime('%d %b') }}</span> 
            to <span class="text-dark fw-bold">{{ week_end.strftime('%d %b %Y') }}</span>
        </p>
    </div>
    
    <div class="d-flex gap-2">
        <button class="btn btn-outline-dark fw-bold" onclick="window.print()">
            <i class="fas fa-print me-2"></i> Print Report
        </button>
        <button class="btn btn-success fw-bold shadow-sm">
            <i class="fas fa-lock me-2"></i> Finalize & Pay
        </button>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm p-3 bg-light">
            <h6 class="text-muted text-uppercase small fw-bold">Total Gross Pay</h6>
            <h2 class="fw-bold text-dark m-0">{{ currency }}{{ "%.2f"|format(totals.gross) }}</h2>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm p-3 bg-danger bg-opacity-10">
            <h6 class="text-danger text-uppercase small fw-bold">Total Taxes & Deductions</h6>
            <h2 class="fw-bold text-danger m-0">- {{ currency }}{{ "%.2f"|format(totals.tax) }}</h2>
            <small class="text-danger opacity-75">
                {% if settings.get('country_code') == 'UK' %}PAYE / NI{% elif settings.get('country_code') == 'US' %}Fed / FICA{% else %}Tax / Social{% endif %}
            </small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm p-3 bg-success bg-opacity-10">
            <h6 class="text-success text-uppercase small fw-bold">Net Payable</h6>
            <h2 class="fw-bold text-success m-0">{{ currency }}{{ "%.2f"|format(totals.net) }}</h2>
            <small class="text-success opacity-75">Transfer Amount</small>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-dark small text-uppercase">
                <tr>
                    <th class="ps-4">Employee</th>
                    <th>Status</th>
                    <th>Hours</th>
                    <th class="text-end text-light">Gross Pay</th>
                    <th class="text-end text-danger">Tax</th>
                    <th class="text-end text-danger">
                        {% if settings.get('country_code') == 'UK' %}NI{% elif settings.get('country_code') == 'US' %}FICA{% else %}Social{% endif %}
                    </th>
                    <th class="text-end pe-4 text-success">Net Pay</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for p in payroll %}
                <tr>
                    <td class="ps-4">
                        <div class="fw-bold text-dark">{{ p.name }}</div>
                        <div class="small text-muted">{{ p.role }}</div>
                    </td>
                    <td>
                        {% if p.type == 'Sub-Contractor' %}
                            <span class="badge bg-warning text-dark border">Contractor</span>
                        {% else %}
                            <span class="badge bg-info text-dark border">PAYE</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="fw-bold">{{ p.hours }} hrs</div>
                        <div class="small text-muted">({{ p.days }} days)</div>
                    </td>
                    <td class="text-end fw-bold text-dark bg-light border-start">
                        {{ currency }}{{ "%.2f"|format(p.gross) }}
                    </td>
                    <td class="text-end text-danger small">
                        {% if p.tax > 0 %}- {{ currency }}{{ "%.2f"|format(p.tax) }}{% else %}-{% endif %}
                    </td>
                    <td class="text-end text-danger small border-end">
                        {% if p.social > 0 %}- {{ currency }}{{ "%.2f"|format(p.social) }}{% else %}-{% endif %}
                    </td>
                    <td class="text-end pe-4 fw-bold text-success bg-success bg-opacity-10">
                        {{ currency }}{{ "%.2f"|format(p.net) }}
                    </td>
                    <td class="text-end">
                        <a href="/hr/staff/{{ p.id }}" class="btn btn-sm btn-outline-secondary" title="View Profile">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="8" class="text-center py-5 text-muted">No active staff records found for this week.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="mt-4 p-3 bg-light border rounded small text-muted">
    <i class="fas fa-info-circle me-2"></i> 
    <strong>Note:</strong> Tax calculations are estimates based on standard national brackets for <strong>{{ settings.get('country_code', 'UK') }}</strong>. 
    Actual payroll submissions should be verified with your accountant or official payroll software.
</div>
{% endblock %}