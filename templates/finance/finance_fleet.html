{% extends "finance/finance_base.html" %}

{% block title %}Fleet Manager | Business Better{% endblock %}

{% block head %}
<style>
    .vehicle-card { 
        border-left: 5px solid var(--brand-color); 
        transition: transform 0.2s; cursor: pointer; 
    }
    .vehicle-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .date-danger { color: #dc3545; font-weight: bold; }
    .date-warn { color: #ffc107; font-weight: bold; }
    .date-ok { color: #198754; }
    .crew-checkbox { transform: scale(1.2); cursor: pointer; }
    
    /* Map Styles */
    #fleetMap { height: 600px; width: 100%; border-radius: 15px; border: 1px solid #ddd; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold m-0">Fleet Command</h2>
            <p class="text-muted mb-0">Track vehicle costs, location, and crew</p>
        </div>
        
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary fw-bold" data-bs-toggle="modal" data-bs-target="#addVehicleModal">
                <i class="fas fa-plus me-2"></i>New Vehicle
            </button>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="fleetTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active fw-bold" id="list-tab" data-bs-toggle="tab" data-bs-target="#listView" type="button">
                <i class="fas fa-th-large me-2"></i>Vehicle List
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link fw-bold" id="map-tab" data-bs-toggle="tab" data-bs-target="#mapView" type="button" onclick="initFleetMap()">
                <i class="fas fa-map-marked-alt me-2"></i>Live Map
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="listView">
            <div class="row g-4">
                {% for v in vehicles %}
                <div class="col-xl-6">
                    <div class="card p-3 shadow-sm vehicle-card border-0 h-100" data-bs-toggle="modal" data-bs-target="#detailModal{{ v.id }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <h4 class="fw-bold m-0">{{ v.reg_number }}</h4>
                                    <span class="badge bg-secondary">{{ v.make_model }}</span>
                                </div>
                                <div class="small text-muted mb-2">
                                    {% if v.driver_name %}
                                        <i class="fas fa-user-circle text-primary me-1"></i> {{ v.driver_name }} (Driver)
                                    {% else %}
                                        <span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i> No Driver</span>
                                    {% endif %}
                                </div>
                                
                                {% if v.crew %}
                                    <div class="d-flex flex-wrap gap-1 mt-2">
                                        {% for c in v.crew %}
                                            <span class="badge bg-info text-dark border"><i class="fas fa-hard-hat me-1"></i> {{ c.name }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                <h4 class="fw-bold text-success m-0">£{{ "%.2f"|format(v.total_gang_cost) }}</h4>
                                <small class="text-muted">Daily Run Cost</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="detailModal{{ v.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="/finance/fleet">
                                <input type="hidden" name="action" value="assign_crew">
                                <input type="hidden" name="vehicle_id" value="{{ v.id }}">
                                
                                <div class="modal-header">
                                    <h5 class="modal-title fw-bold">{{ v.reg_number }} - Settings</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row g-2 mb-3">
                                        <div class="col-6">
                                            <label class="small fw-bold">Vehicle Cost/Day (£)</label>
                                            <input type="number" step="0.01" name="daily_cost" value="{{ v.daily_cost }}" class="form-control">
                                        </div>
                                        <div class="col-6">
                                            <label class="small fw-bold">Tracker URL (Optional)</label>
                                            <input type="text" name="tracker_url" value="{{ v.tracker_url or '' }}" class="form-control" placeholder="http://...">
                                        </div>
                                    </div>

                                    <div class="bg-light p-3 rounded border">
                                        <h6 class="fw-bold border-bottom pb-2 mb-3">Assign Crew</h6>
                                        <div class="row g-2" style="max-height: 200px; overflow-y: auto;">
                                            <div class="col-12 mb-2 p-2 bg-white border rounded">
                                                <i class="fas fa-steering-wheel text-primary me-2"></i> 
                                                <strong>{{ v.driver_name or 'No Driver Assigned' }}</strong> 
                                                <span class="badge bg-secondary float-end">Driver</span>
                                                <div class="small text-muted ps-4">To change driver, edit the Job or Staff profile.</div>
                                            </div>

                                            {% for staff in all_staff %}
                                                {% if staff.id != v.assigned_driver_id %}
                                                <div class="col-md-6">
                                                    <div class="form-check bg-white p-2 border rounded">
                                                        <input class="form-check-input crew-checkbox" type="checkbox" name="crew_ids" value="{{ staff.id }}" id="s{{ v.id }}{{ staff.id }}"
                                                        {% if staff.name in v.crew|map(attribute='name')|list %}checked{% endif %}>
                                                        <label class="form-check-label fw-bold ms-2" for="s{{ v.id }}{{ staff.id }}">
                                                            {{ staff.name }}
                                                        </label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <div class="row g-2 mt-3">
                                        <div class="col-4"><label class="small">MOT Due</label><input type="date" name="mot_expiry" value="{{ v.mot_expiry }}" class="form-control"></div>
                                        <div class="col-4"><label class="small">Tax Due</label><input type="date" name="tax_expiry" value="{{ v.tax_expiry }}" class="form-control"></div>
                                        <div class="col-4"><label class="small">Ins Due</label><input type="date" name="ins_expiry" value="{{ v.ins_expiry }}" class="form-control"></div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <a href="/finance/fleet/delete/{{ v.id }}" class="btn btn-outline-danger btn-sm" onclick="return confirm('Archive this vehicle?')">Archive</a>
                                    <button type="submit" class="btn btn-primary fw-bold">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="mapView">
            <div class="card border-0 shadow-sm p-2">
                <div id="fleetMap"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addVehicleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" action="/finance/fleet">
                    <input type="hidden" name="action" value="add_vehicle">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">Add New Vehicle</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-6"><label class="fw-bold">Reg Plate</label><input type="text" name="reg_number" class="form-control" required></div>
                            <div class="col-6"><label class="fw-bold">Make/Model</label><input type="text" name="make_model" class="form-control" required></div>
                            <div class="col-6"><label class="fw-bold">Daily Cost (£)</label><input type="number" step="0.01" name="daily_cost" class="form-control"></div>
                            <div class="col-6"><label class="fw-bold">Tracker URL</label><input type="text" name="tracker_url" class="form-control"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary fw-bold">Add Vehicle</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    var mapInitialized = false;
    var map;

    function initFleetMap() {
        if (mapInitialized) {
            setTimeout(() => { map.invalidateSize(); }, 200);
            return; 
        }

        // Initialize Map centered on UK (or your default location)
        map = L.map('fleetMap').setView([54.5, -3.0], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Add Markers for Vehicles with Trackers
        // (In production, this would fetch coordinates from the Tracker URL API)
        
        // Example logic: Iterate through vehicles to plot them
        // Note: Real tracking requires an API integration, this puts dummy markers for vehicles with URLs
        {% for v in vehicles %}
            {% if v.tracker_url %}
                // Simulation: Random offset for demo (Remove in production)
                var lat = 51.5 + (Math.random() - 0.5);
                var lon = -0.1 + (Math.random() - 0.5);
                
                L.marker([lat, lon]).addTo(map)
                    .bindPopup("<b>{{ v.reg_number }}</b><br>{{ v.driver_name or 'Unassigned' }}");
            {% endif %}
        {% endfor %}

        mapInitialized = true;
    }
</script>
{% endblock %}