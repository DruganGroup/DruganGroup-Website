{% extends "finance/finance_base.html" %}

{% block title %}Fleet Costs | Business Better{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0">Fleet Cost Control</h2>
        <button class="btn btn-primary fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#editVehicleModal">
            <i class="fas fa-plus me-2"></i> Add Vehicle
        </button>
    </div>

    <div class="row g-4">
        {% for v in vehicles %}
        <div class="col-xl-4 col-md-6">
            <div class="card h-100 border-0 shadow-sm" style="border-top: 4px solid var(--brand-color);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h4 class="fw-bold mb-0">{{ v.reg_plate }}</h4>
                            <div class="small text-muted">{{ v.make_model }}</div>
                        </div>
                        <span class="badge {{ 'bg-success' if v.status == 'Active' else 'bg-danger' }}">{{ v.status }}</span>
                    </div>

                    <div class="bg-light p-3 rounded mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small fw-bold text-muted">Daily Cost:</span>
                            <span class="fw-bold text-dark">£{{ "%.2f"|format(v.daily_cost) }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="small fw-bold text-muted">Driver:</span>
                            <span class="fw-bold text-primary">{{ v.driver_name or 'Unassigned' }}</span>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button class="btn btn-outline-secondary btn-sm" 
                            data-bs-toggle="modal" data-bs-target="#editVehicleModal"
                            data-id="{{ v.id }}" data-reg="{{ v.reg_plate }}" data-model="{{ v.make_model }}"
                            data-status="{{ v.status }}" data-driver="{{ v.assigned_driver_id }}"
                            data-mot="{{ v.mot_due }}" data-tax="{{ v.tax_due }}" 
                            data-ins="{{ v.insurance_due }}" data-serv="{{ v.service_due }}"
                            data-tracker="{{ v.tracker_url }}"
                            onclick="fillEditModal(this)">
                            <i class="fas fa-edit me-2"></i> Manage Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-center py-5"><p class="text-muted">No vehicles found.</p></div>
        {% endfor %}
    </div>

    <div class="modal fade" id="editVehicleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">Vehicle Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="action" value="update_vehicle">
                        <input type="hidden" name="vehicle_id" id="edit_id">
                        
                        <div class="row g-3">
                            <div class="col-md-4"><label class="small fw-bold">Reg Plate</label><input type="text" name="reg_plate" id="edit_reg" class="form-control" required></div>
                            <div class="col-md-4"><label class="small fw-bold">Make/Model</label><input type="text" name="make_model" id="edit_model" class="form-control" required></div>
                            <div class="col-md-4"><label class="small fw-bold">Status</label>
                                <select name="status" id="edit_status" class="form-select">
                                    <option value="Active">Active</option>
                                    <option value="VOR">VOR (Off Road)</option>
                                    <option value="Sold">Sold</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6"><label class="small fw-bold">Assigned Driver</label>
                                <select name="driver_id" id="edit_driver" class="form-select">
                                    <option value="">-- None --</option>
                                    {% for s in staff %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6"><label class="small fw-bold">Daily Cost (£)</label><input type="number" step="0.01" name="daily_cost" class="form-control"></div>
                            
                            <div class="col-12"><hr></div>
                            <div class="col-md-3"><label class="small fw-bold">MOT Due</label><input type="date" name="mot_expiry" id="edit_mot" class="form-control"></div>
                            <div class="col-md-3"><label class="small fw-bold">Tax Due</label><input type="date" name="tax_due" id="edit_tax" class="form-control"></div>
                            <div class="col-md-3"><label class="small fw-bold">Ins Due</label><input type="date" name="insurance_due" id="edit_ins" class="form-control"></div>
                            <div class="col-md-3"><label class="small fw-bold">Service Due</label><input type="date" name="service_due" id="edit_serv" class="form-control"></div>
                            
                            <div class="col-12"><label class="small fw-bold">Tracker URL</label><input type="text" name="tracker_url" id="edit_tracker" class="form-control"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary fw-bold">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    function fillEditModal(btn) {
        document.getElementById('edit_id').value = btn.getAttribute('data-id');
        document.getElementById('edit_reg').value = btn.getAttribute('data-reg');
        document.getElementById('edit_model').value = btn.getAttribute('data-model');
        document.getElementById('edit_status').value = btn.getAttribute('data-status');
        document.getElementById('edit_mot').value = btn.getAttribute('data-mot');
        document.getElementById('edit_tax').value = btn.getAttribute('data-tax');
        document.getElementById('edit_ins').value = btn.getAttribute('data-ins');
        document.getElementById('edit_serv').value = btn.getAttribute('data-serv');
        document.getElementById('edit_tracker').value = btn.getAttribute('data-tracker');
        
        let driver = btn.getAttribute('data-driver');
        document.getElementById('edit_driver').value = (driver && driver !== 'None') ? driver : '';
    }
</script>
{% endblock %}