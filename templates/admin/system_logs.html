{% extends "admin/base.html" %}

{% block title %}System Logs | Business Better{% endblock %}

{% block styles %}
<style>
    .table-dark-custom th { color: var(--primary-gold) !important; border-color: #444 !important; }
    .log-trace { background: #000; color: #ff3333; padding: 15px; font-family: monospace; font-size: 0.75rem; border-left: 3px solid #ff3333; margin: 10px 0; white-space: pre-wrap; }
    .user-pill { background: #222; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; color: #fff; border: 1px solid #444; }
    .btn-page { border: 1px solid var(--primary-gold); color: var(--primary-gold); padding: 5px 10px; margin: 0 2px; text-decoration: none; border-radius: 4px; }
    .btn-page:hover { background: var(--primary-gold); color: black; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-end mb-4">
    <h2 class="fw-bold text-white">System <span class="text-gold">Logs</span></h2>
</div>

<div class="card-dark shadow-lg">
    <table class="table table-dark-custom table-hover mb-0">
        <thead>
            <tr>
                <th>Time</th>
                <th>Status</th>
                <th>Route</th>
                <th>User / Company</th>
                <th>Message</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td class="small text-muted" style="white-space:nowrap;">{{ log[1] }}</td>
                <td>
                    {% if log[9] >= 500 %}<span class="badge bg-danger">{{ log[9] }}</span>
                    {% elif log[9] >= 400 %}<span class="badge bg-warning text-dark">{{ log[9] }}</span>
                    {% else %}<span class="badge bg-secondary">{{ log[9] }}</span>{% endif %}
                </td>
                <td><code class="text-gold">{{ log[5] }}</code></td>
                <td>
                    {% if log[7] %}<div class="user-pill mb-1"><i class="fas fa-user me-1"></i> {{ log[7] }}</div>{% endif %}
                    {% if log[8] %}<div class="small text-muted">{{ log[8] }}</div>{% endif %}
                    <div class="small text-muted" style="font-size:0.7rem;">{{ log[6] }}</div> </td>
                <td style="max-width:300px; word-wrap:break-word;">{{ log[3] }}</td>
                <td><button class="btn btn-sm btn-outline-secondary" onclick="toggleTrace({{ log[0] }})">View Trace</button></td>
            </tr>
            <tr id="trace-{{ log[0] }}" style="display:none; background:#0a0a0a;"><td colspan="6"><div class="log-trace">{{ log[4] }}</div></td></tr>
            {% else %}
            <tr><td colspan="6" class="text-center p-5 text-success">âœ… System is healthy.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if total_pages > 1 %}
    <div class="d-flex justify-content-center p-3">
        {% for p in range(1, total_pages + 1) %}
        <a href="{{ url_for('admin.view_system_logs', page=p) }}" class="btn-page">{{ p }}</a>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
function toggleTrace(id) {
    var x = document.getElementById('trace-' + id);
    x.style.display = (x.style.display === "none") ? "table-row" : "none";
}
</script>
{% endblock %}