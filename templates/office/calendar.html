{% extends "office/office_base.html" %}

{% block title %}Schedule | Business Better{% endblock %}

{% block head %}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <style>
        .fc-toolbar-title { font-size: 1.5rem !important; font-weight: bold; }
        .fc-button-primary { background-color: var(--brand-color) !important; border: none !important; }
        .fc-day-today { background-color: rgba(var(--brand-rgb), 0.05) !important; }
        #calendar { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .fc-event-main { cursor: move; }
        .job-card { cursor: grab; border-left: 4px solid var(--brand-color); }
        .job-card:active { cursor: grabbing; }
        .job-list-container { max-height: 80vh; overflow-y: auto; padding-right: 5px; }
    </style>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold m-0">Master Schedule</h2>
            <p class="text-muted mb-0">Drag jobs to assign dates. Gangs auto-fill based on Van selection.</p>
        </div>
        <div class="bg-white px-3 py-2 rounded-pill shadow-sm small border">
            <span class="me-3"><i class="fas fa-circle text-primary me-1"></i> Scheduled</span>
            <span class="me-3"><i class="fas fa-circle text-success me-1"></i> Completed</span>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold border-bottom py-3">
                    <i class="fas fa-clipboard-list me-2 text-secondary"></i> Unscheduled
                </div>
                <div class="card-body bg-light p-3">
                    <div id="external-events" class="job-list-container">
                        {% for job in unscheduled_jobs %}
                        <div class="card mb-2 border-0 shadow-sm job-card fc-event" 
								data-id="{{ job.id }}" 
								data-title="{{ job.client }}" 
								data-color="#0d6efd"
								data-pre-vehicle="{{ job.pre_vehicle_id or '' }}"
								data-duration="{{ job.duration_iso }}"> ``` 
							 <div class="card-body p-3">
                                <strong class="text-dark small">{{ job.ref }}</strong>
                                <div class="fw-bold text-primary mt-1">{{ job.client }}</div>
                                <div class="small text-muted text-truncate">{{ job.desc }}</div>
                                <div class="small text-muted mt-2">
                                    <i class="fas fa-map-marker-alt me-1"></i> {{ job.postcode }}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4"><p class="small mb-0">No unscheduled jobs.</p></div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div id='calendar'></div>
        </div>
    </div>

    <div class="modal fade" id="assignModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-users-cog me-2"></i>Assign Crew & Van</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted mb-3">Assigning job for <span id="modalDateDisplay" class="fw-bold text-dark"></span></p>
                    
                    <input type="hidden" id="modalJobId">
                    <input type="hidden" id="modalDate">

                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Vehicle</label>
                        <select class="form-select shadow-sm fw-bold" id="modalVehicle" onchange="autoFillGang()">
                            <option value="">-- Choose Van --</option>
                            {% for v in fleet %}
                                <option value="{{ v.id }}" 
                                        data-driver="{{ v.driver_id }}" 
                                        data-crew='{{ v.crew_ids|tojson }}'>
                                    {{ v.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text small text-success" id="gang-msg" style="display:none;">
                            <i class="fas fa-magic me-1"></i> Gang auto-selected from Fleet settings.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Lead Engineer (Driver)</label>
                        <select class="form-select shadow-sm" id="modalLead">
                            <option value="">-- Select Driver --</option>
                            {% for s in staff %}
                                <option value="{{ s.id }}">{{ s.name }} ({{ s.role }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Crew Members (Multi-Select)</label>
                        <select class="form-select shadow-sm" id="modalCrew" multiple style="height: 120px;">
                            {% for s in staff %}
                                <option value="{{ s.id }}">{{ s.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text small">Hold Ctrl/Cmd to adjust selection manually.</div>
                    </div>

                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success w-100 fw-bold" onclick="confirmAssignment()">
                        <i class="fas fa-check-circle me-2"></i> Confirm Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // 1. GET CSRF TOKEN (The Key to Fix Error 400)
    var csrfToken = "{{ csrf_token() if csrf_token is defined else '' }}";

    var calendar; 
    var assignModal;

    function autoFillGang() {
        var vehicleSelect = document.getElementById('modalVehicle');
        var selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
        
        var driverId = selectedOption.getAttribute('data-driver');
        var crewData = selectedOption.getAttribute('data-crew');
        
        // Check if driverId is valid (Not 0, Not 'None', Not Empty)
        if (driverId && driverId != '0' && driverId != 'None') {
            document.getElementById('modalLead').value = driverId;
            
            var crewIds = JSON.parse(crewData || '[]');
            var crewSelect = document.getElementById('modalCrew');
            
            for (var i = 0; i < crewSelect.options.length; i++) {
                crewSelect.options[i].selected = crewIds.includes(parseInt(crewSelect.options[i].value));
            }
            document.getElementById('gang-msg').style.display = 'block';
        } else {
            // Reset if no driver assigned to van
            document.getElementById('modalLead').value = "";
            document.getElementById('gang-msg').style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        var Calendar = FullCalendar.Calendar;
        var Draggable = FullCalendar.Draggable;
        var containerEl = document.getElementById('external-events');
        var calendarEl = document.getElementById('calendar');
        assignModal = new bootstrap.Modal(document.getElementById('assignModal'));

        new Draggable(containerEl, {
            itemSelector: '.fc-event',
            eventData: function(eventEl) {
                return {
                    title: eventEl.getAttribute('data-title'),
                    id: eventEl.getAttribute('data-id'),
                    color: eventEl.getAttribute('data-color'),
                    extendedProps: { preVehicle: eventEl.getAttribute('data-pre-vehicle') }
                };
            }
        });

        calendar = new Calendar(calendarEl, {
            locale: 'en-gb', firstDay: 1, slotMinTime: '06:00:00',
            initialView: 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
            editable: true, droppable: true,
            events: '/office/calendar/data',
            
            eventReceive: function(info) {
                document.getElementById('modalJobId').value = info.event.id;
                document.getElementById('modalDate').value = info.event.startStr;
                document.getElementById('modalDateDisplay').innerText = info.event.startStr;
                
                var preVehicle = info.event.extendedProps.preVehicle;
                if (preVehicle && preVehicle !== 'None') {
                    document.getElementById('modalVehicle').value = preVehicle;
                    autoFillGang(); 
                } else {
                    document.getElementById('modalVehicle').value = "";
                    document.getElementById('modalLead').value = "";
                    document.getElementById('gang-msg').style.display = 'none';
                }

                info.event.setProp('backgroundColor', '#ffc107'); 
                assignModal.show();
            },

            eventDrop: function(info) {
                // ADDED CSRF TOKEN HERE TOO
                fetch('/office/calendar/reschedule-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken  // <--- KEY FIX
                    },
                    body: JSON.stringify({ job_id: info.event.id, date: info.event.startStr })
                });
            }
        });
        calendar.render();
    });

    function confirmAssignment() {
        var jobId = document.getElementById('modalJobId').value;
        var date = document.getElementById('modalDate').value;
        var vehicleId = document.getElementById('modalVehicle').value;
        var leadId = document.getElementById('modalLead').value;
        
        var crewSelect = document.getElementById('modalCrew');
        var crewIds = Array.from(crewSelect.selectedOptions).map(option => option.value);

        if(!vehicleId) { alert("Please select a vehicle!"); return; }
        if(!leadId) { alert("Please select a Lead Engineer!"); return; }

        fetch('/office/calendar/schedule-job', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken  // <--- KEY FIX
            },
            body: JSON.stringify({ 
                job_id: jobId, 
                date: date, 
                vehicle_id: vehicleId,
                lead_id: leadId,
                crew_ids: crewIds
            })
        })
        .then(response => {
            // Handle valid JSON or HTML errors (like 400/500 pages)
            if (!response.ok) { throw new Error("Server Error: " + response.status); }
            return response.json();
        })
        .then(data => {
            if(data.status === 'success') {
                assignModal.hide();
                calendar.refetchEvents(); 
                var card = document.querySelector(`.job-card[data-id="${jobId}"]`);
                if(card) card.remove();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Failed to schedule. Check console for details.");
        });
    }
</script>
{% endblock %}