{% extends "office/office_base.html" %}

{% block title %}Schedule | Business Better{% endblock %}

{% block head %}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js'></script>
    
    <style>
        .fc-toolbar-title { font-size: 1.5rem !important; font-weight: bold; }
        .fc-button-primary { background-color: var(--brand-color) !important; border: none !important; }
        .fc-day-today { background-color: rgba(var(--brand-rgb), 0.05) !important; }
        
        #calendar { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        /* Draggable Job Card Styles */
        .fc-event-main { cursor: move; }
        .job-card {
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid var(--brand-color);
        }
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
        }
        .job-card:active { cursor: grabbing; }
        
        /* Scrollable Sidebar for Jobs */
        .job-list-container {
            max-height: 80vh;
            overflow-y: auto;
            padding-right: 5px;
        }
        .job-list-container::-webkit-scrollbar { width: 5px; }
        .job-list-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    </style>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold m-0">Master Schedule</h2>
            <p class="text-muted mb-0">Drag jobs to assign dates</p>
        </div>
        <div class="bg-white px-3 py-2 rounded-pill shadow-sm small border">
            <span class="me-3"><i class="fas fa-circle text-primary me-1"></i> Jobs</span>
            <span class="me-3"><i class="fas fa-circle text-danger me-1"></i> MOT/Tax</span>
            <span><i class="fas fa-circle text-warning me-1"></i> Service</span>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold border-bottom py-3">
                    <i class="fas fa-clipboard-list me-2 text-secondary"></i> Unscheduled Jobs
                </div>
                <div class="card-body bg-light p-3">
                    <div id="external-events" class="job-list-container">
                        
                        {% for job in unscheduled_jobs %}
                        <div class="card mb-2 border-0 shadow-sm job-card fc-event" 
                             data-id="{{ job.id }}" 
                             data-title="{{ job.client }}" 
                             data-color="#0d6efd">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between">
                                    <strong class="text-dark small">{{ job.ref }}</strong>
                                    <span class="badge bg-white text-dark border">1 Day</span>
                                </div>
                                <div class="fw-bold text-primary mt-1">{{ job.client }}</div>
                                <div class="small text-muted text-truncate">{{ job.desc }}</div>
                                <div class="small text-muted mt-2">
                                    <i class="fas fa-map-marker-alt me-1"></i> {{ job.postcode }}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-check-circle fa-2x mb-2 opacity-50"></i>
                            <p class="small mb-0">No unscheduled jobs.</p>
                        </div>
                        {% endfor %}

                    </div>
                    <div class="mt-3 small text-muted text-center fst-italic">
                        <i class="fas fa-info-circle me-1"></i> Drag cards onto the calendar
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div id='calendar'></div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. SETTINGS & LOCALE ---
        var countryCode = "{{ settings.get('country_code', 'UK') }}"; 
        var localeMap = { 'UK': 'en-gb', 'IE': 'en-ie', 'US': 'en-us', 'CAN': 'en-ca', 'AUS': 'en-au', 'NZ': 'en-nz' };
        var myLocale = localeMap[countryCode] || 'en-gb';

        var Calendar = FullCalendar.Calendar;
        var Draggable = FullCalendar.Draggable;

        var containerEl = document.getElementById('external-events');
        var calendarEl = document.getElementById('calendar');

        // Initialize Draggable (Left Side)
        new Draggable(containerEl, {
            itemSelector: '.fc-event',
            eventData: function(eventEl) {
                return {
                    title: eventEl.getAttribute('data-title'),
                    id: eventEl.getAttribute('data-id'),
                    color: eventEl.getAttribute('data-color')
                };
            }
        });

        // Initialize Calendar (Right Side)
        var calendar = new Calendar(calendarEl, {
            locale: myLocale,       
            firstDay: 1,            // <--- FORCE MONDAY START
            slotMinTime: '06:00:00', // <--- START GRID AT 6 AM
            
            // Visual Business Hours (Highlights 8am-6pm)
            businessHours: {
                daysOfWeek: [ 1, 2, 3, 4, 5 ], 
                startTime: '08:00', 
                endTime: '18:00', 
            },

            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            height: 'auto',
            editable: true,
            droppable: true,
            events: '/office/calendar/data',
            
            // HANDLER: Dragging New Job
            eventReceive: function(info) {
                var jobId = info.event.id;
                var date = info.event.startStr;
                
                fetch('/office/calendar/schedule-job', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ job_id: jobId, date: date })
                })
                .then(response => response.json())
                .then(data => {
                    if(data.status === 'success') {
                        info.event.setProp('backgroundColor', '#198754');
                        info.event.setProp('borderColor', '#198754');
                    } else {
                        alert('Error scheduling job');
                        info.revert();
                    }
                });
            },

            // HANDLER: Moving Existing Job
            eventDrop: function(info) {
                var jobId = info.event.id;
                var date = info.event.startStr;

                fetch('/office/calendar/reschedule-job', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ job_id: jobId, date: date })
                });
            }
        });

        calendar.render();
    });
</script>
{% endblock %}