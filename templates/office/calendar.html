{% extends "office/office_base.html" %}

{% block title %}Schedule | Business Better{% endblock %}

{% block head %}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <style>
        .fc-toolbar-title { font-size: 1.5rem !important; font-weight: bold; }
        .fc-button-primary { background-color: var(--brand-color) !important; border: none !important; }
        .fc-day-today { background-color: rgba(var(--brand-rgb), 0.05) !important; }
        #calendar { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .fc-event-main { cursor: move; }
        .job-card { cursor: grab; border-left: 4px solid var(--brand-color); }
        .job-card:active { cursor: grabbing; }
        .job-list-container { max-height: 80vh; overflow-y: auto; padding-right: 5px; }
    </style>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold m-0">Master Schedule</h2>
            <p class="text-muted mb-0">Drag jobs to assign dates & vans</p>
        </div>
        <div class="bg-white px-3 py-2 rounded-pill shadow-sm small border">
            <span class="me-3"><i class="fas fa-circle text-primary me-1"></i> Scheduled</span>
            <span class="me-3"><i class="fas fa-circle text-success me-1"></i> Completed</span>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold border-bottom py-3">
                    <i class="fas fa-clipboard-list me-2 text-secondary"></i> Unscheduled
                </div>
                <div class="card-body bg-light p-3">
                    <div id="external-events" class="job-list-container">
                        {% for job in unscheduled_jobs %}
                        <div class="card mb-2 border-0 shadow-sm job-card fc-event" 
                             data-id="{{ job.id }}" 
                             data-title="{{ job.client }}" 
                             data-color="#0d6efd">
                            <div class="card-body p-3">
                                <strong class="text-dark small">{{ job.ref }}</strong>
                                <div class="fw-bold text-primary mt-1">{{ job.client }}</div>
                                <div class="small text-muted text-truncate">{{ job.desc }}</div>
                                <div class="small text-muted mt-2">
                                    <i class="fas fa-map-marker-alt me-1"></i> {{ job.postcode }}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4"><p class="small mb-0">No unscheduled jobs.</p></div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div id='calendar'></div>
        </div>
    </div>

    <div class="modal fade" id="assignModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-shuttle-van me-2"></i>Dispatch Job</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted mb-3">Select the vehicle for this job. The assigned Driver and Crew will be notified.</p>
                    
                    <input type="hidden" id="modalJobId">
                    <input type="hidden" id="modalDate">
                    
                    <label class="small fw-bold text-dark mb-2">Select Van / Crew</label>
                    <select id="modalVehicle" class="form-select form-select-lg mb-3 shadow-sm border-2">
                        <option value="">-- Choose Van --</option>
                        {% for v in fleet %}
                            <option value="{{ v.id }}">{{ v.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-success w-100 fw-bold py-2" onclick="confirmAssignment()">
                        <i class="fas fa-check-circle me-2"></i> Confirm & Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    var calendar; 
    var assignModal;

    document.addEventListener('DOMContentLoaded', function() {
        var Calendar = FullCalendar.Calendar;
        var Draggable = FullCalendar.Draggable;
        var containerEl = document.getElementById('external-events');
        var calendarEl = document.getElementById('calendar');
        assignModal = new bootstrap.Modal(document.getElementById('assignModal'));

        new Draggable(containerEl, {
            itemSelector: '.fc-event',
            eventData: function(eventEl) {
                return {
                    title: eventEl.getAttribute('data-title'),
                    id: eventEl.getAttribute('data-id'),
                    color: eventEl.getAttribute('data-color')
                };
            }
        });

        calendar = new Calendar(calendarEl, {
            locale: 'en-gb', firstDay: 1, slotMinTime: '06:00:00',
            initialView: 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
            editable: true, droppable: true,
            events: '/office/calendar/data',
            
            // 1. DROP HANDLER
            eventReceive: function(info) {
                document.getElementById('modalJobId').value = info.event.id;
                document.getElementById('modalDate').value = info.event.startStr;
                
                // Show "Pending" color yellow
                info.event.setProp('backgroundColor', '#ffc107'); 
                
                assignModal.show();
            },

            // 2. MOVE HANDLER (Date change only)
            eventDrop: function(info) {
                fetch('/office/calendar/reschedule-job', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ job_id: info.event.id, date: info.event.startStr })
                });
            }
        });
        calendar.render();
    });

    // 3. SAVE BUTTON HANDLER
    function confirmAssignment() {
        var jobId = document.getElementById('modalJobId').value;
        var date = document.getElementById('modalDate').value;
        var vehicleId = document.getElementById('modalVehicle').value;

        if(!vehicleId) { alert("Please select a vehicle!"); return; }

        fetch('/office/calendar/schedule-job', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ job_id: jobId, date: date, vehicle_id: vehicleId })
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                assignModal.hide();
                calendar.refetchEvents(); // Refresh to show correct color
                var card = document.querySelector(`.job-card[data-id="${jobId}"]`);
                if(card) card.remove();
            } else {
                alert('Error: ' + data.message);
            }
        });
    }
</script>
{% endblock %}