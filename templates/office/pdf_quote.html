<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ 'Invoice' if not is_quote else 'Quote' }} {{ invoice.ref }}</title>
    <style>
        @page { size: A4; margin: 0; }
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: #333;
            margin: 0;
            padding: 40px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        /* BRANDING VARIABLES (Injected by Python) */
        :root { --brand-color: {{ config.get('color', '#333') }}; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; margin-bottom: 50px; }
        .logo-container img { max-height: 80px; max-width: 250px; object-fit: contain; }
        .company-info { text-align: right; font-size: 12px; color: #666; }
        .company-info h2 { margin: 0 0 5px 0; color: var(--brand-color); font-size: 18px; }

        /* CLIENT & DOC INFO GRID */
        .info-grid { display: flex; justify-content: space-between; margin-bottom: 40px; }
        .client-box { width: 45%; }
        .doc-details { width: 40%; text-align: right; }
        
        h3 { font-size: 11px; text-transform: uppercase; color: #999; margin-bottom: 5px; letter-spacing: 1px; }
        .address-block { font-size: 14px; font-weight: 500; }

        .big-badge { 
            background: var(--brand-color); 
            color: white; 
            padding: 5px 15px; 
            font-size: 14px; 
            font-weight: bold; 
            display: inline-block; 
            border-radius: 4px;
            margin-bottom: 10px;
        }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th { text-align: left; padding: 12px 8px; border-bottom: 2px solid #eee; color: #999; font-size: 11px; text-transform: uppercase; }
        td { padding: 12px 8px; border-bottom: 1px solid #eee; }
        .col-right { text-align: right; }
        .col-center { text-align: center; }
        tr:last-child td { border-bottom: none; }

        /* TOTALS */
        .totals-container { display: flex; justify-content: flex-end; }
        .totals-box { width: 40%; }
        .total-row { display: flex; justify-content: space-between; padding: 5px 0; }
        .total-row.grand { 
            font-size: 18px; 
            font-weight: bold; 
            border-top: 2px solid var(--brand-color); 
            margin-top: 10px; 
            padding-top: 10px; 
            color: var(--brand-color);
        }

        /* FOOTER & BANKING */
        .footer-grid { display: flex; justify-content: space-between; margin-top: 60px; padding-top: 20px; border-top: 1px solid #eee; }
        .bank-details { background: #f9f9f9; padding: 15px; border-radius: 6px; width: 45%; border-left: 4px solid var(--brand-color); }
        .terms { width: 45%; font-size: 11px; color: #777; }
        
        .bank-label { font-size: 10px; text-transform: uppercase; color: #999; display: block; }
        .bank-val { font-weight: bold; font-size: 13px; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo-container">
            {% if config.logo %}
                <img src="{{ config.logo }}" alt="Company Logo">
            {% else %}
                <h1>{{ company.name }}</h1>
            {% endif %}
        </div>
        <div class="company-info">
            <h2>{{ company.name }}</h2>
            {% if settings.get('company_address') %}{{ settings.company_address }}<br>{% endif %}
            {{ settings.get('company_email') }}<br>
            {{ settings.get('company_phone') }}<br>
            {% if settings.get('vat_number') %}VAT Reg: {{ settings.vat_number }}{% endif %}
        </div>
    </div>

    <div class="info-grid">
        <div class="client-box">
            <h3>Bill To:</h3>
            <div class="address-block">
                <strong>{{ invoice.client_name }}</strong><br>
                {{ invoice.client_address | replace(',', '<br>') | safe }}
            </div>
            {% if invoice.client_email %}<div style="margin-top:5px; font-size:12px;">{{ invoice.client_email }}</div>{% endif %}
        </div>
        <div class="doc-details">
            <div class="big-badge">{{ 'QUOTE' if is_quote else 'INVOICE' }}</div>
            <div><strong>Ref:</strong> #{{ invoice.ref }}</div>
            <div><strong>Date:</strong> {{ invoice.date }}</div>
            {% if invoice.due_date and not is_quote %}
                <div><strong>Due Date:</strong> {{ invoice.due_date }}</div>
            {% endif %}
            {% if is_quote and invoice.expiry %}
                <div><strong>Expires:</strong> {{ invoice.expiry }}</div>
            {% endif %}
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th width="50%">Description</th>
                <th width="10%" class="col-center">Qty</th>
                <th width="20%" class="col-right">Price</th>
                <th width="20%" class="col-right">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>
                    <strong>{{ item.desc }}</strong>
                    {% if item.notes %}<br><span style="color:#777; font-size:11px;">{{ item.notes }}</span>{% endif %}
                </td>
                <td class="col-center">{{ item.qty }}</td>
                <td class="col-right">£{{ "%.2f"|format(item.price) }}</td>
                <td class="col-right">£{{ "%.2f"|format(item.total) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="totals-container">
        <div class="totals-box">
            <div class="total-row">
                <span>Subtotal:</span>
                <span>£{{ "%.2f"|format(invoice.total) }}</span> {# Assuming this is net #}
            </div>
            
            {% if settings.get('vat_registered') == 'yes' %}
            <div class="total-row">
                <span>VAT (20%):</span>
                <span>£{{ "%.2f"|format(invoice.total * 0.2) }}</span>
            </div>
            {% endif %}
            
            <div class="total-row grand">
                <span>Total Due:</span>
                <span>£{{ "%.2f"|format(invoice.total * 1.2 if settings.get('vat_registered') == 'yes' else invoice.total) }}</span>
            </div>
        </div>
    </div>

    <div class="footer-grid">
        <div class="bank-details">
            <div style="margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:5px; font-weight:bold;">Payment Details</div>
            
            <span class="bank-label">Bank Name</span>
            <span class="bank-val">{{ settings.get('bank_name', 'Not Provided') }}</span>
            
            <div style="display:flex; justify-content:space-between;">
                <div>
                    <span class="bank-label">Sort Code</span>
                    <span class="bank-val">{{ settings.get('sort_code', '--') }}</span>
                </div>
                <div>
                    <span class="bank-label">Account No</span>
                    <span class="bank-val">{{ settings.get('account_number', '--') }}</span>
                </div>
            </div>
        </div>

        <div class="terms">
            <strong>Terms & Conditions</strong><br>
            {{ settings.get('invoice_footer', 'Payment is due within 14 days. Thank you for your business.') }}
            <br><br>
            {% if is_quote %}
                <div style="border-top:1px dashed #ccc; padding-top:10px; margin-top:10px;">
                    <strong>Client Signature:</strong><br><br><br>
                    __________________________<br>
                    Date:
                </div>
            {% endif %}
        </div>
    </div>

</body>
</html>