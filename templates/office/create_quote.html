{% extends "office/office_base.html" %}

{% block title %}New Quote | Business Better{% endblock %}

{% block content %}
<form method="POST" id="quoteForm" action="/office/quote/save-unified">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold m-0">Create New Quote</h2>
            <p class="text-muted mb-0">Unified Estimator & Quote Engine</p>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="bg-dark text-white px-3 py-2 rounded text-end shadow-sm">
                <small class="d-block text-white-50" style="font-size: 0.7rem;">ESTIMATED TOTAL</small>
                <span class="fw-bold fs-5" id="headerTotal">£0.00</span>
            </div>
            <button type="submit" class="btn btn-success fw-bold px-4 shadow-sm">
                <i class="fas fa-check me-2"></i> Save Quote
            </button>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-user me-2"></i> Client Details</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="newClientToggle" onchange="toggleClientMode()">
                        <label class="form-check-label small text-muted" for="newClientToggle">New?</label>
                    </div>
                </div>
                <div class="card-body bg-light">
                    <div id="existingClientDiv">
                        <select name="client_id" class="form-select shadow-sm mb-3">
                            <option value="" selected disabled>-- Search Clients --</option>
                            {% for c in clients %}
                            <option value="{{ c.id }}" {% if pre_client == c.id|string %}selected{% endif %}>{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div id="newClientDiv" class="d-none mb-3">
                        <input type="text" name="new_client_name" class="form-control mb-2" placeholder="Client Name">
                        <input type="email" name="new_client_email" class="form-control mb-2" placeholder="Email">
                        <input type="text" name="new_client_phone" class="form-control" placeholder="Phone">
                    </div>

                    <hr>
                    
                    <label class="form-label fw-bold small text-muted">Site Address / Property</label>
                    <select name="property_id" id="propertySelect" class="form-select mb-3">
                        <option value="">-- Select Client First --</option>
                    </select>

                    <label class="form-label fw-bold small text-muted">Job Title</label>
                    <input type="text" name="job_title" class="form-control mb-3" placeholder="e.g. Garden Fencing" required>

                    <label class="form-label fw-bold small text-muted">Scope of Works</label>
                    <textarea name="job_description" class="form-control" rows="3" placeholder="Brief description..."></textarea>
                    
                    <hr>

                    <h6 class="fw-bold text-primary"><i class="fas fa-truck me-2"></i>Resources</h6>
                    
                    <label class="form-label fw-bold small text-muted">Est. Duration (Days)</label>
                    <input type="number" step="0.5" name="estimated_days" id="daysInput" class="form-control mb-3" value="1" oninput="calcTotal()" required>

                    <label class="form-label fw-bold small text-muted">Preferred Gang / Van</label>
                    <select name="preferred_vehicle_id" id="vehicleSelect" class="form-select" onchange="calcTotal()">
                        <option value="" data-cost="0">-- No Vehicle Cost --</option>
                        {% for v in vehicles %}
                            <option value="{{ v.id }}" data-cost="{{ v.daily_cost or 0 }}">
                                {{ v.reg_plate }} 
                                {% if v.make_model %} - {{ v.make_model }}{% endif %}
                                {% if v.daily_cost and v.daily_cost > 0 %}
                                    (+£{{ "%.2f"|format(v.daily_cost) }}/day)
                                {% endif %}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="small text-muted mt-1" id="resourceCostDisplay">Resource Cost: £0.00</div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-list me-2"></i> Quote Items</span>
                    <div>
                        <button type="button" class="btn btn-sm btn-warning fw-bold text-dark me-2" data-bs-toggle="modal" data-bs-target="#smartCalcModal">
                            <i class="fas fa-magic me-1"></i> Auto-Calc
                        </button>
                        <span class="badge bg-light text-dark border border-warning">
                            Markup: {{ settings.get('default_markup', 20) }}%
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <table class="table align-middle mb-0" id="itemsTable">
                        <thead class="bg-light text-uppercase small text-muted">
                            <tr>
                                <th class="ps-4" style="width: 50%;">Description</th>
                                <th style="width: 15%;">Qty</th>
                                <th style="width: 20%;">Unit Price</th>
                                <th class="text-end pe-4">Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody">
                            </tbody>
                    </table>
                    
                    <div class="p-3 bg-light border-top d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-outline-primary btn-sm fw-bold" onclick="addRow()">
                            <i class="fas fa-plus me-1"></i> Add Line
                        </button>
                        
                        <div class="text-end">
                            <div class="small text-muted">Materials: <span id="matTotal">0.00</span></div>
                            <div class="small text-muted">Resources (Van/Gang): <span id="resTotal">0.00</span></div>
                            <div class="small text-muted">Tax ({{ (tax_rate * 100)|int }}%): <span id="taxTotal">0.00</span></div>
                            <div class="h5 fw-bold m-0 text-dark">Total: <span id="grandTotal">0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<div class="modal fade" id="smartCalcModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title fw-bold text-dark"><i class="fas fa-magic me-2"></i>Smart Estimator</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label fw-bold">Select Trade</label>
                <select id="calcType" class="form-select mb-3" onchange="renderDynamicForm()">
                    <option value="" disabled selected>Loading trades...</option>
                </select>

                <div id="dynamicFormContainer" class="p-2 border rounded bg-light">
                    <p class="text-center text-muted small my-3">Select a trade to load inputs.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-dark w-100" onclick="runSmartCalc()">
                    <i class="fas fa-calculator me-2"></i> Calculate & Import
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .suggestions-box {
        position: absolute; background: white; border: 1px solid #ddd; 
        z-index: 1000; width: 90%; max-height: 200px; overflow-y: auto; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 0 0 5px 5px;
    }
    .suggestion-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
    .suggestion-item:hover { background-color: #f8f9fa; color: var(--brand-color); }
    .suggestion-cost { font-size: 0.8rem; color: #dc3545; float: right; }
</style>

<script>
    // 1. CONFIGURATION
    const TAX_RATE = {{ tax_rate }};
    const storedMarkup = {{ settings.get('default_markup', 20) }};
    const MARKUP = 1 + (parseFloat(storedMarkup) / 100);
    let CALCULATORS = []; // Store definitions from backend

    // 2. PREVENT ENTER KEY SUBMIT
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && event.target.tagName !== 'TEXTAREA') {
            event.preventDefault();
            return false;
        }
    });

    // 3. TOGGLE CLIENT (New vs Existing)
    function toggleClientMode() {
        const isNew = document.getElementById('newClientToggle').checked;
        document.getElementById('existingClientDiv').classList.toggle('d-none', isNew);
        document.getElementById('newClientDiv').classList.toggle('d-none', !isNew);
    }

    // 4. LOAD CALCULATORS (ON PAGE LOAD)
    document.addEventListener('DOMContentLoaded', function() {
        // A. Load Rows & Clients
        addRow(); 
        const clientSelect = document.querySelector('select[name="client_id"]');
        if (clientSelect) {
            clientSelect.addEventListener('change', function() { loadProperties(this.value); });
            if (clientSelect.value) loadProperties(clientSelect.value);
        }

        // B. Fetch Calculator Definitions from Python
        fetch('/api/calculators/meta')
            .then(res => {
                if (!res.ok) throw new Error("Failed to load calculators");
                return res.json();
            })
            .then(data => {
                CALCULATORS = data;
                const dropdown = document.getElementById('calcType');
                dropdown.innerHTML = '<option value="" disabled selected>-- Select Trade --</option>';
                
                // Populate Dropdown Dynamically
                data.forEach(calc => {
                    const opt = document.createElement('option');
                    opt.value = calc.id;
                    opt.text = calc.name;
                    dropdown.appendChild(opt);
                });
            })
            .catch(err => console.error("Calculator Error:", err));
    });

    // 5. RENDER DYNAMIC FORM (The Magic Part)
    function renderDynamicForm() {
        const type = document.getElementById('calcType').value;
        const calc = CALCULATORS.find(c => c.id === type);
        const container = document.getElementById('dynamicFormContainer');
        
        container.innerHTML = ''; // Clear previous inputs

        if (!calc || !calc.fields) return;

        // Loop through the fields defined in Python
        calc.fields.forEach(field => {
            const wrapper = document.createElement('div');
            wrapper.className = 'mb-3';
            
            // Label
            const label = document.createElement('label');
            label.className = 'small fw-bold text-muted mb-1';
            label.innerText = field.label;
            wrapper.appendChild(label);

            // Input Logic
            let input;
            if (field.type === 'select') {
                input = document.createElement('select');
                input.className = 'form-select';
                field.options.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt.value;
                    o.text = opt.label;
                    input.appendChild(o);
                });
            } else {
                input = document.createElement('input');
                input.type = field.type || 'text'; // 'number' or 'text'
                input.className = 'form-control';
                if (field.default) input.value = field.default;
                if (field.placeholder) input.placeholder = field.placeholder;
            }
            
            input.dataset.key = field.id;   // Store the key name for retrieval
            
            wrapper.appendChild(input);
            container.appendChild(wrapper);
        });
    }

    // 6. RUN SMART CALC (Reads dynamic inputs)
    function runSmartCalc() {
        const tradeType = document.getElementById('calcType').value;
        const container = document.getElementById('dynamicFormContainer');
        const inputs = container.querySelectorAll('input, select');
        
        let payload = {};
        
        // Auto-harvest values based on Python's definition
        inputs.forEach(el => {
            payload[el.dataset.key] = el.value;
        });

        // Send to Backend
        fetch(`/api/calculate/${tradeType}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) throw new Error("Calculation failed");
            return response.json();
        })
        .then(data => {
            // Close Modal
            bootstrap.Modal.getInstance(document.getElementById('smartCalcModal')).hide();
            
            // A. Populate Rows from 'materials' list
            if(data.materials) {
                // Optional: Add a separator/header row
                // addRow(`--- ${data.summary} ---`, 1, 0); 

                data.materials.forEach(item => {
                    const cost = parseFloat(item.est_cost || 0);
                    // Apply Markup
                    const sellPrice = (cost * MARKUP).toFixed(2);
                    addRow(item.name, item.qty, sellPrice);
                });
            }

            // B. Update Duration (Days) based on labor_hours
            if(data.labor_hours) {
                // Convert Hours to Days (round up to nearest 0.5)
                let days = Math.ceil((data.labor_hours / 8) * 2) / 2;
                if (days < 0.5) days = 0.5;
                
                document.getElementById('daysInput').value = days;
                
                // Recalculate Van/Gang costs immediately
                calcTotal(); 
            }
        })
        .catch(err => alert("Error: " + err));
    }

    // 7. ADD ROW (Manual & Auto)
    function addRow(desc='', qty=1, price='') {
        const tbody = document.getElementById('itemsBody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="ps-4 position-relative">
                <input type="text" name="desc[]" class="form-control item-search" 
                       value="${desc}" placeholder="Start typing item..." autocomplete="off" onkeyup="searchMaterials(this)">
                <div class="suggestions-box d-none"></div>
            </td>
            <td><input type="number" name="qty[]" class="form-control text-center" value="${qty}" min="0.1" step="0.1" oninput="calcTotal()"></td>
            <td><input type="number" name="price[]" class="form-control" value="${price}" placeholder="0.00" step="0.01" oninput="calcTotal()"></td>
            <td class="text-end pe-4 fw-bold row-total">0.00</td>
            <td><button type="button" class="btn btn-link text-danger p-0" onclick="this.closest('tr').remove(); calcTotal()"><i class="fas fa-times"></i></button></td>
        `;
        tbody.appendChild(row);
        calcTotal();
    }

    // 8. CALCULATE TOTALS (Standard Logic)
    function calcTotal() {
        // A. Material Total
        let matTotal = 0;
        document.querySelectorAll('#itemsBody tr').forEach(row => {
            const qty = parseFloat(row.querySelector('[name="qty[]"]').value) || 0;
            const price = parseFloat(row.querySelector('[name="price[]"]').value) || 0;
            const total = qty * price;
            row.querySelector('.row-total').innerText = total.toFixed(2);
            matTotal += total;
        });

        // B. Resource Total (Days * Vehicle Daily Cost)
        const days = parseFloat(document.getElementById('daysInput').value) || 0;
        const vehicleSelect = document.getElementById('vehicleSelect');
        
        let dailyCost = 0;
        if(vehicleSelect.selectedIndex >= 0) {
            dailyCost = parseFloat(vehicleSelect.options[vehicleSelect.selectedIndex].getAttribute('data-cost')) || 0;
        }
        
        const resTotal = days * dailyCost;

        // C. Update Displays
        document.getElementById('resourceCostDisplay').innerText = `Resource Cost: £${resTotal.toFixed(2)}`;
        document.getElementById('matTotal').innerText = matTotal.toFixed(2);
        document.getElementById('resTotal').innerText = resTotal.toFixed(2);

        // D. Grand Total
        const subtotal = matTotal + resTotal;
        const tax = subtotal * TAX_RATE;
        const grand = subtotal + tax;

        document.getElementById('taxTotal').innerText = tax.toFixed(2);
        document.getElementById('grandTotal').innerText = grand.toFixed(2);
        document.getElementById('headerTotal').innerText = '£' + grand.toFixed(2);
    }

    // 9. AUTO-COMPLETE (Preserved)
    function searchMaterials(input) {
        const box = input.nextElementSibling;
        const query = input.value;
        if (query.length < 2) { box.classList.add('d-none'); return; }

        fetch(`/api/materials/search?q=${query}`)
            .then(res => res.json())
            .then(data => {
                box.innerHTML = '';
                if (data.length > 0) {
                    box.classList.remove('d-none');
                    data.forEach(item => {
                        const sellPrice = (item.cost * MARKUP).toFixed(2);
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerHTML = `<strong>${item.name}</strong> <span class="text-muted small">(${item.supplier})</span> <span class="suggestion-cost">£${sellPrice}</span>`;
                        div.onclick = function() {
                            input.value = item.name;
                            input.closest('tr').querySelector('[name="price[]"]').value = sellPrice;
                            box.classList.add('d-none');
                            calcTotal();
                        };
                        box.appendChild(div);
                    });
                } else {
                    box.classList.add('d-none');
                }
            })
            .catch(err => console.error(err));
    }

    // Close suggestions on click outside
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('item-search')) {
            document.querySelectorAll('.suggestions-box').forEach(box => box.classList.add('d-none'));
        }
    });

    // 10. CLIENT/PROPERTY LOADER
    function loadProperties(clientId) {
        const propSelect = document.getElementById('propertySelect');
        if (!clientId) return;
        propSelect.innerHTML = '<option value="">Loading sites...</option>';
        propSelect.disabled = true;

        fetch(`/api/client/${clientId}/properties`)
            .then(res => res.json())
            .then(data => {
                propSelect.disabled = false;
                propSelect.innerHTML = data.length ? '<option value="">-- Select Site Address --</option>' : '<option value="">-- Use Billing Address --</option>';
                data.forEach(prop => {
                    const opt = document.createElement('option');
                    opt.value = prop.id;
                    opt.text = prop.address;
                    propSelect.appendChild(opt);
                });
            });
    }
</script>
{% endblock %}