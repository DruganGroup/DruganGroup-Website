{% extends "office/office_base.html" %}

{% block title %}New Quote | Business Better{% endblock %}

{% block content %}
<form method="POST" id="quoteForm">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold m-0">Create New Quote</h2>
            <p class="text-muted mb-0">Draft a proposal or estimate</p>
        </div>
        <button type="submit" class="btn btn-success fw-bold px-4 shadow-sm">
            <i class="fas fa-check me-2"></i> Save Quote
        </button>
    </div>

    <div class="row g-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-user me-2"></i> Client Details</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="newClientToggle" onchange="toggleClientMode()">
                        <label class="form-check-label small text-muted" for="newClientToggle">New?</label>
                    </div>
                </div>
                <div class="card-body bg-light">
                    <div id="existingClientDiv">
                        <select name="client_id" class="form-select shadow-sm">
                            <option value="" selected disabled>-- Search Clients --</option>
                            {% for c in clients %}
                            <option value="{{ c.id }}" {% if pre_client == c.id|string %}selected{% endif %}>{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="newClientDiv" class="d-none">
                        <input type="text" name="new_client_name" class="form-control mb-2" placeholder="Client Name">
                        <input type="email" name="new_client_email" class="form-control mb-2" placeholder="Email">
                        <input type="text" name="new_client_phone" class="form-control" placeholder="Phone">
                    </div>
                </div>
            </div>
        </div>
<div class="card shadow-sm border-0 mb-4">
<div class="col-12">
    <label class="form-label fw-bold small text-muted">Site Address / Property</label>
    <select name="property_id" id="propertySelect" class="form-select">
        <option value="">-- Select Client First --</option>
    </select>
    <div class="form-text small">Select the specific property for this work.</div>
</div>
    <div class="card-header bg-secondary text-white fw-bold">
        <i class="fas fa-briefcase me-2"></i> Job Details
    </div>
    <div class="card-body bg-light">
        <div class="row g-3">
            <div class="col-md-8">
                <label class="form-label fw-bold small text-muted">Job Title</label>
                <input type="text" name="job_title" class="form-control" placeholder="e.g. Kitchen Extension" required>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold small text-muted">Est. Duration (Days)</label>
                <input type="number" step="0.5" name="estimated_days" class="form-control" value="1" required>
            </div>
            <div class="col-12">
                <label class="form-label fw-bold small text-muted">Scope of Works</label>
                <textarea name="job_description" class="form-control" rows="2" placeholder="Brief description..."></textarea>
            </div>
            <div class="col-12">
                <label class="form-label fw-bold small text-muted">Preferred Gang / Van</label>
                <select name="preferred_vehicle_id" class="form-select">
                    <option value="">-- No Preference --</option>
                    {% for v in fleet %}
                        <option value="{{ v.id }}">{{ v.name }}</option>
                    {% endfor %}
                </select>
                <div class="form-text small">Select the crew typically assigned to this vehicle.</div>
            </div>
        </div>
    </div>
</div>
        <div class="col-md-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-list me-2"></i> Quote Items</span>
                    <span class="badge bg-warning text-dark border border-warning">
                        Markup: {{ settings.get('default_markup', 20) }}%
                    </span>
                </div>
                <div class="card-body p-0">
                    <table class="table align-middle mb-0" id="itemsTable">
                        <thead class="bg-light text-uppercase small text-muted">
                            <tr>
                                <th class="ps-4" style="width: 50%;">Description</th>
                                <th style="width: 15%;">Qty</th>
                                <th style="width: 20%;">Unit Price</th>
                                <th class="text-end pe-4">Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody">
                            </tbody>
                    </table>
                    
                    <div class="p-3 bg-light border-top d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-outline-primary btn-sm fw-bold" onclick="addRow()">
                            <i class="fas fa-plus me-1"></i> Add Line
                        </button>
                        <div class="text-end">
                            <div class="small text-muted">Net Total: <span id="netTotal">0.00</span></div>
                            <div class="small text-muted">Tax ({{ (tax_rate * 100)|int }}%): <span id="taxTotal">0.00</span></div>
                            <div class="h5 fw-bold m-0 text-dark">Total: <span id="grandTotal">0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<style>
    .suggestions-box {
        position: absolute; background: white; border: 1px solid #ddd; 
        z-index: 1000; width: 90%; max-height: 200px; overflow-y: auto; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 0 0 5px 5px;
    }
    .suggestion-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
    .suggestion-item:hover { background-color: #f8f9fa; color: var(--brand-color); }
    .suggestion-cost { font-size: 0.8rem; color: #dc3545; float: right; }
</style>

<script>
    // 1. SETTINGS
    const TAX_RATE = {{ tax_rate }};
    const storedMarkup = {{ settings.get('default_markup', 20) }};
    const MARKUP = 1 + (parseFloat(storedMarkup) / 100);

    // 2. PREVENT ENTER KEY SUBMIT (The Crash Fix)
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && event.target.tagName !== 'TEXTAREA') {
            event.preventDefault();
            return false;
        }
    });

    // 3. TOGGLE CLIENT MODE
    function toggleClientMode() {
        const isNew = document.getElementById('newClientToggle').checked;
        document.getElementById('existingClientDiv').classList.toggle('d-none', isNew);
        document.getElementById('newClientDiv').classList.toggle('d-none', !isNew);
    }

    // 4. ADD NEW ROW
    function addRow() {
        const tbody = document.getElementById('itemsBody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="ps-4 position-relative">
                <input type="text" name="desc[]" class="form-control item-search" 
                       placeholder="Start typing item..." autocomplete="off" onkeyup="searchMaterials(this)">
                <div class="suggestions-box d-none"></div>
            </td>
            <td><input type="number" name="qty[]" class="form-control text-center" value="1" min="1" oninput="calcTotal()"></td>
            <td><input type="number" name="price[]" class="form-control" placeholder="0.00" step="0.01" oninput="calcTotal()"></td>
            <td class="text-end pe-4 fw-bold row-total">0.00</td>
            <td><button type="button" class="btn btn-link text-danger p-0" onclick="this.closest('tr').remove(); calcTotal()"><i class="fas fa-times"></i></button></td>
        `;
        tbody.appendChild(row);
    }

    // 5. SMART SEARCH (With Debugging)
    function searchMaterials(input) {
        const box = input.nextElementSibling;
        const query = input.value;
        
        // Only search if 2+ chars
        if (query.length < 2) { 
            box.classList.add('d-none'); 
            return; 
        }

        console.log("Searching for:", query); // DEBUG LOG

        fetch(`/api/materials/search?q=${query}`)
            .then(response => {
                if (!response.ok) { throw new Error("API Route Missing or Error"); }
                return response.json();
            })
            .then(data => {
                console.log("Found results:", data); // DEBUG LOG
                box.innerHTML = '';
                
                if (data.length > 0) {
                    box.classList.remove('d-none');
                    data.forEach(item => {
                        const sellPrice = (item.cost * MARKUP).toFixed(2);
                        
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerHTML = `
                            <strong>${item.name}</strong> 
                            <span class="text-muted small">(${item.supplier})</span>
                            <span class="suggestion-cost">Buy: £${item.cost} | Sell: £${sellPrice}</span>
                        `;
                        
                        div.onclick = function() {
                            input.value = item.name;
                            const row = input.closest('tr');
                            row.querySelector('[name="price[]"]').value = sellPrice;
                            box.classList.add('d-none');
                            calcTotal();
                        };
                        box.appendChild(div);
                    });
                } else {
                    box.classList.add('d-none');
                }
            })
            .catch(err => console.error("Search Error:", err));
    }

    // 6. CLOSE BOX ON CLICK OUTSIDE
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('item-search')) {
            document.querySelectorAll('.suggestions-box').forEach(box => box.classList.add('d-none'));
        }
    });

    // 7. CALC TOTALS
    function calcTotal() {
        let net = 0;
        document.querySelectorAll('#itemsBody tr').forEach(row => {
            const qty = parseFloat(row.querySelector('[name="qty[]"]').value) || 0;
            const price = parseFloat(row.querySelector('[name="price[]"]').value) || 0;
            const total = qty * price;
            row.querySelector('.row-total').innerText = total.toFixed(2);
            net += total;
        });
        
        const tax = net * TAX_RATE;
        document.getElementById('netTotal').innerText = net.toFixed(2);
        document.getElementById('taxTotal').innerText = tax.toFixed(2);
        document.getElementById('grandTotal').innerText = (net + tax).toFixed(2);
    }

    document.addEventListener('DOMContentLoaded', addRow);
	
	<script>
    document.addEventListener('DOMContentLoaded', function() {
        const clientSelect = document.querySelector('select[name="client_id"]');
        const propSelect = document.getElementById('propertySelect');

        function loadProperties(clientId) {
            if (!clientId) return;
            
            // Show loading state
            propSelect.innerHTML = '<option value="">Loading sites...</option>';
            propSelect.disabled = true;

            // Fetch from API
            fetch(`/api/client/${clientId}/properties`)
                .then(response => response.json())
                .then(data => {
                    propSelect.disabled = false;
                    if (data.length > 0) {
                        propSelect.innerHTML = '<option value="">-- Select Site Address --</option>';
                        data.forEach(prop => {
                            const option = document.createElement('option');
                            option.value = prop.id;
                            option.text = prop.address;
                            propSelect.appendChild(option);
                        });
                    } else {
                        propSelect.innerHTML = '<option value="">-- Use Billing Address (Default) --</option>';
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    propSelect.innerHTML = '<option value="">Error loading sites</option>';
                });
        }

        if (clientSelect) {
            // 1. Listen for changes (User picks a new client)
            clientSelect.addEventListener('change', function() {
                loadProperties(this.value);
            });

            // 2. Check on Page Load (If client is pre-selected)
            if (clientSelect.value) {
                loadProperties(clientSelect.value);
            }
        }
    });
</script>
</script>
{% endblock %}